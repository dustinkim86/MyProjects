# 책 들어와써? (Is This Book In?)

- 알라딘 오프라인 중고서점 재고보유 알림 시스템
- 제작 기간 : 2020/03/02 ~ 

  ![login](https://user-images.githubusercontent.com/52812181/77646494-fc386f80-6fa7-11ea-82e6-625613f6b322.png)

<br/>

## 프로젝트 시작 계기

- 알라딘 중고매장 페이지를 사용하면서 느꼈던 문제점들
  - 내가 원하는 책이 있는지, 있다면 어느 지점에 있는지 검색을 하지 않으면 알 수 없음
  - PC에서는 알라딘 중고매장 검색어 내역 저장 불가 
  - 모바일 앱에서는 최대 10개 까지의 검색어가 최근 내역에 남으나, 일일이 검색이 느리다는 단점

- 위와 같은 단점을 보완한 서비스를 만들면 편리하지 않을까 생각하여 시작

  

<br/>

## 만들고자 하는 솔루션

- 알라딘 중고매장 검색 페이지 크롤링을 통해 고객이 등록한 도서 검색 결과를 알림으로 보내주는 서비스
  - 약 하루 2회 : 알라딘 중고매장 DB가 초기화되는 시간인 9시 30분과 대부분의 퇴근 시간인 18시 (30분)에 알리미 전송
  - 고객은 원하는 책이 언제 어디 지점에 들어왔는지 지정된 시간에 알림받을 수 있음



<br/>

## 프로토타입 설계시 문제점들

- 무료 알림 채널의 부재
  - 카카오톡 / SMS 등 건당 비용 발생
- 수익성을 보고 진행하는 프로젝트가 아니기에 금전적인 부분을 고려하지 않을 수 없음
- 대체 알림 서비스 : 인스타그램 다이렉트 메세지
  - 인스타그램 공식 API는 메세지 전송 기능이 없어 개인이 개발한 [instagram API](https://github.com/LevPasha/Instagram-API-python) 사용
- 홈페이지 구성 시 발생하는 문제점
  - Ajax 등 자바스크립트 관련 배경지식 부재. 부분적인 동적화면 미구현
    - 부작용으로 사용자가 등록한 키워드가 많을수록 메인화면 접속에 이르기까지 장시간이 걸림



<br/>

## 프로토타입 설계 결과

- 알림 기능은 추후 추가하는 것으로 하고, 먼저 웹 페이지를 제작하는 방향으로 Pivoting
- 고객이 들어와서 자신의 키워드를 등록하고, 저장된 검색어를 버튼으로 쉽게 검색할 수 있도록 함
- DB는 2개의 테이블로 구성(사용자, 키워드)


<br/>

## 내부 디렉토리 구조

```python
itbi
┖ __pycache__
┖ static
  ┖ image
┖ templates
  ┖ error.html			# 각종 에러 메세지 출력
  ┖ firstGuide.html		# '처음 사용자를 위한 가이드' 출력
  ┖ joinOnPage.html		# 회원가입 페이지 구성
  ┖ joininPage.html		# 로그인 페이지 구성
  ┖ keywordPage.html	  # 키워드 관리 페이지 구성
  ┖ mainPage.html		# 검색 페이지 구성
Procfile			# heroku ps 할당
app.py				# 플라스크 실행 파일 
app.yaml
instadm.py			# 인스타그램 DM 실행 파일
requirements.txt	  # 필요한 라이브러리 모음
runtime.txt			# 실행파일 파이썬 버전
```

<br/>

## 사용 프로그램

- HTML5 : 홈페이지 프레임 제작 (로그인, 회원가입, 검색, 키워드 관리 페이지)
- CSS3 : 구성요소 디자인, 미디어 쿼리를 통한 반응형 페이지 제작
- Python (Flask) : 서버 연결 (Django보다 좀 더 가벼운 Flask 사용)
- ~~SQLite :  데이터 수집을 위한 DB구성 (사용자 정보 테이블, 키워드 테이블로 구성)~~
- MySQL : heroku에 있는 ClearDB-MySQL을 DB로 사용. Flask-MySQL, Flask-RESTful 라이브러리를 사용하여 웹과 DB를 연동
- Javascript : 버튼 클릭 등 동적인 기능 구성
- 협업 도구로는 깃허브(Github)와 노션(Notion)을 사용
- 초기 배포는 goorm과 ngrok을 이용한 localhost 외부접속, 최종 배포는 heroku를 사용



<br/>

## 설계 과정

1. **프로토타입 설계**
   - 알림 채널 알아보기, 웹 페이지 구성으로 피봇팅
   - 프로젝트 계획 구상 (Notion)

   
   
2. **크롤링 코드 작성** : 알라딘 중고매장 검색 결과를 크롤링 할 수 있는 코드 작성
   
   - `Requests` , `BeautifulSoup`을 통한 html 파싱
   - `urlencode` 를 통해 검색 결과 url 자동 접속
- 사용자가 저장한 각 검색어의 검색 결과 첫 페이지의 최대 7권의 도서 검색 결과(제목, 서지정보, 보유지점) 크롤링
  
   
  
3. **웹 페이지 제작**

   - **로그인 페이지** : 사이트 접속 시 가장 먼저 랜딩되는 페이지
     
     - 로그인 정보(유저 ID, 휴대전화번호)를 입력할 수 있도록 UI 구성
     - 아이디와 패스워드가 맞지 않을 경우 에러 메시지 출력 (SQL 활용)
     - 세션(session)을 활용하여 로그인 후 로그아웃 이전까지 유저ID 유지
     - 로그인 시 유저가 등록한 모든 키워드에 대한 크롤링 선 실행
     - 초기 사용자를 위한 가이드 안내(키워드 관리 페이지 가이드와 동일)
     
   - **회원가입 페이지** : 최초 사용자를 위한 회원가입 페이지

     - 회원가입 정보를 받아 DB에 저장 ~~(유저 테이블에 저장할 유저ID, 휴대전화번호, 성별, 연령대, 가입일)~~

       (인스타그램ID, 생년월일, 성별, 연령대, 가입일)

     - ~~아이디에 영문 또는 숫자가 아닌 특수문자 등을 사용하거나, 기존에 동일한 아이디가 있을 경우 가입이 되지 않고 에러 메시지를 출력하도록 함~~

       실제 사용 중인 인스타그램ID로 회원가입 해 인스타그램 DM 알림 서비스에 활용 유도

     - ~~휴대전화번호를 010으로 시작하지 않거나 11자리에 맞지 않을 경우 가입이 되지 않고 에러 메시지를 출력하도록 함~~

       초기 휴대전화번호를 이용한 알림서비스에 접근하고자 하였으나 생년월일로 간소화 해 개인정보 입력 최소화

     - 성별과 연령대도 Radio로 구성하여 입력하지 않을 경우에 에러 메시지를 출력하도록 함

     - 모든 데이터를 제대로 입력한 후 가입하기 버튼을 누를 경우 회원가입이 완료되고 정보가 DB(유저 테이블)에 저장

   - **검색 페이지** : 고객이 실제로 검색 결과를 볼 수 있는 페이지
     
     - 키워드 관리 페이지에서 고객이 등록한 키워드만을 화면에 버튼으로 표시
     - 버튼을 누르면 키워드에 맞춰 크롤링한 결과 추출
     
   - **키워드 관리 페이지** : 키워드를 등록하고 삭제할 수 있는 페이지
     
     - 초기 사용자를 위한 가이드 안내(로그인 페이지 가이드와 동일)
     - 자신이 원하는 키워드를 입력하고 *'등록하기'* 버튼을 클릭하여 등록
     - 기존 키워드 중 필요 없어진 키워드는 클릭하여 삭제할 수 있도록 함
     - *'메인으로'* 버튼을 통해 검색 페이지로 돌아갈 수 있도록 함
     
     

- **DB구성** : 유저 테이블, 키워드 테이블 2가지로 구성

  - **유저 테이블**
    - idx (인덱스) : PK(Primary Key). auto_increment. 코드에서는 ID로 식별하므로 따로 사용하지 않는다. (idx의 끝에 2, 12, 22, 32 ... 식으로 2가 붙는 것은 ClearDB 자체의 Strategy라고 한다)
    - userid (인스타그램ID) : 영문과 숫자로만 이루어지도록 하여 수집
    - password (생년월일) : 010으로 시작하는 11자리 숫자의 형태로 수집. 추후 알림 서비스로 확장 시 사용.
    - gender (성별) : 남성, 여성, LGBTQ를 각각 1, 2, 3 의 Int 형태로 저장
    - age (연령대) : 10대부터 60대까지 1 ~ 6의 Int 형태로 저장 
    - joinDate (가입일) : yyyy-mm-dd의 Date형태로 저장

  

  - **키워드 테이블**
    - key_idx (인덱스) : PK(Primary Key). auto_increment (idx의 끝에 2, 12, 22, 32 ... 식으로 2가 붙는 것은 ClearDB 자체의 Strategy라고 한다)
    - userid (인스타그램ID) : FK(Foreign Key)
    - keyword (키워드) : varchar(string)의 형태로 저장
    - keyAddDate (추가 날짜) : yyyy-mm-dd의 Date형태로 저장
    - actDeact (등록상태 구분) : 키워드 추가시 Default값은 1이며, 키워드를 삭제하면 0으로 변경
  
    ![schema](https://user-images.githubusercontent.com/52812181/77621305-89b39980-6f7f-11ea-984f-33945d620df2.png)
  
  - 추후 관심분야 테이블 추가 예정

- **웹과 DB 연동하기**
  
  - ~~SQLAlchemy 라이브러리를 사용하여 2개의 테이블을 웹과 연동~~
  - GCP(PaaS), VM Instance(IaaS), heroku(PaaS) 를 통해 배포하려 하였으나 SQLite를 지원하지 않아 MySQL을 사용하는 것으로 선회
  - heroku에 있는 ClearDB-MySQL사용
  
- **서버를 통해 배포**
  
  - 초기 테스트를 위해 구름(goorm)을 통해 서버에 올림(무료서버인 탓에 잦은 끊김 발생)
    - ngrok을 이용해 localhost 서버를 외부 접속이 가능하게 하여 테스트
  - 본격적으로 heroku를 통해 배포



<br/>

## 버그 리포팅

- ~~키워드 관리 페이지에서 삭제 후 새로고침을 하면 에러가 발생~~ (해결)
- ~~등록되지 않은 아이디를 사용하여 접속하려고 하면 에러가 발생~~(해결)
- 유저가 9 ~ 10개의 키워드를 입력한 경우. '로그인'이나 '메인으로'를 클릭하여 검색 페이지로 넘어가면서 30초 이상 걸려 heroku에서 H12에러를 발생시키는 현상. 크롤링을 하는 데 30초 내외가 걸리기 때문에 서버 상태에 따라 에러가 발생할 때도 있고 아닐 때도 있음



<br/>

## 추후 발전 과제

- CSS 수정
  - ~~현재 검색 결과 출력시 화면 칸이 깨지는 경우가 있어 추후 수정~~
  - 그 외 구성요소(각종 모바일 디바이스) 디자인 수정 계획
- Ajax를 통해서 키워드 클릭시에 검색이 될 수 있도록 수정
  - 현재는 검색 결과 페이지 접속(로그인 또는 키워드 관리 페이지에서 '메인으로' 클릭) 시, 모든 키워드에 대한 크롤링이 자동으로 되도록 되어있음. 추후 Ajax를 통해 특정 키워드 버튼을 클릭 시 해당 키워드에 대한 검색 결과만 크롤링되는 방향으로 수정 계획
  - 로그인 등 메인 페이지로 이동하는 시간 향상 효과. 페이지로 넘어갈 때 30초 이상 걸리는 경우 heroku에서 발생하는 에러방지.
- 회원가입 시 관심분야를 수집할 수 있도록 하고 DB에 저장
  - 회원 가입 페이지에서 관심 분야를 중복 선택할 수 있도록 설정
  - 관심분야 테이블을 따로 만들어 유저의 관심 분야를 저장하도록 함 
- ~~텔레그램 등 알림채널 알아보기 + 연동~~ (인스타그램API를 활용하여 DM을 보내는 것으로 변경)
  - ~~기존에 자세히 알아보지 못했던 알림 채널(텔레그램 등)을 알아보고 적정 채널을 찾아 원래 목표인 알림 기능 구현.~~
  - 비공식 인스타그램 API를 사용하여 DM으로 전송
  - ~~회원가입시 받았던 휴대전화번호로 알림 발송~~ 회원가입시 인스타그램에서 사용하는 이름을 입력하도록 변경하고 휴대전화번호 대신 생년월일을 입력하도록 한다. 그리고 해당 Column의 Unique 속성을 제외
  - 인스타그램 API와 APScheduler를 이용하여 알림 서비스 구성. 해당 파일 heroku 배포
    - **문제점 발생** : 로컬 실행 시 문제 없이 잘 전송되나, 서버(Heroku, GCP 등)에서 실행 시 API 내부 direct_message() 함수 실행 안됨
  - 로컬 컴퓨터의 스케쥴러 또는 라즈베리파이를 이용해 자동 DM발송 


<br/>

## 결과물

- Main Page(데스크탑 화면)  

  ![maincom](https://user-images.githubusercontent.com/52812181/77646630-43266500-6fa8-11ea-8df6-7f7d7abf2438.png)

<br/>

- Main Page(모바일 화면)  

  <img src="https://user-images.githubusercontent.com/52812181/77647436-c2686880-6fa9-11ea-89fc-0ff9ba17da79.png" width="350" height="600">


<br/>

- Keyword Page(데스크탑 화면)  

  ![keywordcom](https://user-images.githubusercontent.com/52812181/77646852-afa16400-6fa8-11ea-9faf-717261635fca.png)

<br/>

- Keyword Page(모바일 화면)  

  <img src="https://user-images.githubusercontent.com/52812181/77646932-d790c780-6fa8-11ea-9833-c4e6af10bc9c.png" width="350" height="600">

<br/>

- Join on Page  

  <img src="https://user-images.githubusercontent.com/52812181/77646968-f0997880-6fa8-11ea-993f-8fe1bb29d8f1.png" width="600" height="750">

<br/>

- 처음 사용자 가이드 팝업  

  <img src="https://user-images.githubusercontent.com/52812181/77647634-1bd09780-6faa-11ea-81cc-dbc1d8447679.png" width="600" height="750">
